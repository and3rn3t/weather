name: 🧪 Test & Build Only

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of tests to run'
        required: false
        default: 'fast'
        type: choice
        options:
          - fast
          - coverage
          - full

permissions:
  contents: read
  pull-requests: write

env:
  NODE_VERSION: '22'
  NPM_CONFIG_PREFER_OFFLINE: true
  NPM_CONFIG_NO_AUDIT: true
  NPM_CONFIG_NO_FUND: true
  NPM_CONFIG_PROGRESS: false
  NPM_CONFIG_LOGLEVEL: error

jobs:
  test-build:
    name: 🧪 Test & Build
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - name: ⚡ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ⚡ Setup Node.js + Cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ⚡ Install dependencies
        run: |
          npm ci --prefer-offline --no-audit --no-fund --silent

      - name: 🔍 Lint check
        run: |
          npm run lint --silent || echo "⚠️ Lint warnings (non-blocking)"
        continue-on-error: true

      - name: ✨ Prettier check
        run: |
          npm run format:check

      - name: 🔒 Type-check
        run: |
          npm run type-check

      - name: 🧪 Run tests
        run: |
          if [ "${{ inputs.test_type }}" = "coverage" ]; then
            npm run test:coverage
          elif [ "${{ inputs.test_type }}" = "full" ]; then
            npm run test
          else
            npm run test:fast
          fi

      - name: 🏗️ Build application
        run: |
          npm run build:ultra

      - name: 📊 Build summary
        run: |
          echo "## 🧪 Test & Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "**Test Type**: ${{ inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build**: ✅ Successful" >> $GITHUB_STEP_SUMMARY
          if [ -d "dist" ]; then
            echo "**Bundle Size**: $(du -sh dist | cut -f1)" >> $GITHUB_STEP_SUMMARY
          fi
